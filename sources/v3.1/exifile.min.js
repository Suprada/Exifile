exifile=function(){const metadat_name="exifile",metadat_version="2.0",metadat_tagline="Free your Scribd highlights from the cloud",metadat_description="When you create highlights and notes when reading your Scribd books, there is no way to see them in one page or to download them. This bookmarklet helps you to excise and file those Scribd highlights.  It gives you a single clean page with all your notes and highlights which can be copies, and gives you the option to download it in plain text format or JSON format. The highlights and notes can also be downloaded in plain text or JSON format.",metadat_keywords=["scribd","note","highlight"],metadat_author="Suprada Urval <suprada@oddumbrella.com> (https://oddumbrella.com)",metadat_bugs={email:"suprada@oddumbrella.com"},metadat_homepage="https://oddumbrella.com/exifile",metadat_license="MIT",e=document.createElement("div"),hostName=location.hostname,readPath=location.pathname.split("/")[1];let verticalScrolling=!1,highlights={},anns=[];function initExifile(){makeOverlayAndSetMessage(e),verticalScrolling=document.getElementsByClassName("vertical_reader_container").length>0,verticalScrolling?startScrapingPage():(e.innerHTML="<h3>Vertical scrolling is not enabled.</h3><h3>Exifile will enable vertical scrolling.</h3><h3>Please click on exifile bookmarklet again after page reloads</h3>",console.log("vertical scrolling is not enabled. Exifile will enable vertical scrolling. Please click on exifile bookmarklet again after page reloads"),window.location.href=window.location.origin+window.location.pathname+"?mode=standard")}function makeOverlayAndSetMessage(e){e.setAttribute("class","overlay-info"),document.body.appendChild(e),"www.scribd.com"!==hostName?(e.innerHTML="<h1>Login to your book at www.scribd.com to start.</h1>",addCloseButton(e)):"www.scribd.com"===hostName&&"read"!==readPath?(e.innerHTML="<h1>Please start reading book</h1>",addCloseButton(e)):"www.scribd.com"===hostName&&"read"===readPath&&(e.innerHTML="<h1>Exifiling...</h1><h3>Takes about 5 mins-ish. Time for a cup of coffee...</h3><p id='exifiling-status'>Starting Exifiling... <span id='polling'></span></p><p className='updatedOn'>Exifile updated on March 13, 2020</p>")}async function startScrapingPage(){highlights=getBookMeta(highlights);const numChapters=goToCoverPage();if(highlights.annotations=await getNotesAndBookmarks(),highlights.annotations){const lastPage=getLastPage(highlights.annotations);let t=await timeout(2e3),bookHighlights=await readBook(lastPage,numChapters);const keys=Object.keys(bookHighlights),updated=keys.map(item=>{const{id:id,text:text}=bookHighlights[item],t={};return t.id=id,t.text=text.join(" "),t});reconcileHighlights(highlights,updated)}else console.log("no annotations found"),e.innerHTML="<h1>Exifile</h1><h2>This book has no highlights.</h2>",addCloseButton(e)}function reconcileHighlights(highlights,bookHighlights){const newAnnotations=highlights.annotations.reverse().map((item,ind)=>(item.excerpt=bookHighlights[ind].text,item));highlights.annotations=newAnnotations,showHighlightsWithButtons(e,highlights)}function getBookMeta(obj){const{title:title,author_name:author_name}=Scribd.current_doc;return obj.isbn=document.querySelector('meta[property="books:isbn"]').getAttribute("content"),obj.title=title,obj.authors=[author_name],obj}async function waitForAnnotations(){let emptyModal=null,annotations=null,elem=null;return new Promise(async resolve=>{for(;null===elem||0===elem.length;)elem=document.getElementById("notebook_modal"),await timeout(300);for(;null===emptyModal&&(null===annotations||0===annotations.length);)annotations=elem.getElementsByClassName("annotation"),emptyModal=elem.getElementsByClassName("empty_notebook"),await timeout(300);resolve(!0)})}async function getNotesAndBookmarks(){let annotations=[];document.getElementsByClassName("icon-ic_overflowmenu")[0].parentElement.click(),document.getElementsByClassName("icon-ic_notebook")[0].parentElement.click(),await waitForAnnotations();const items=document.getElementsByClassName("annotation");if(items.length>0){for(let item of items){const location=item.getElementsByClassName("page_num")[0].innerHTML,type=item.getElementsByClassName("annotation_type")[0].innerHTML,time=item.getElementsByClassName("time")[0].innerHTML,excerpt=item.getElementsByClassName("excerpt")[0].innerHTML;excerpt&&""!==excerpt&&"No preview available"!==excerpt&&"highlight"===type&&annotations.push({location:location,type:type,time:time,excerpt:excerpt})}return closeModal(),annotations}return closeModal(),console.log("no notes and bookmarks available in this book"),null}initExifile();const closeModal=()=>{const closeBtn=document.getElementsByClassName("icon-ic_close")&&document.getElementsByClassName("icon-ic_close_small");closeBtn.length>0&&closeBtn[0].click()};function getLastPage(annotations){const lastPage=document.getElementById("footer").innerText.split(" ")[3].split(",")[0];return Number(lastPage)}function goToCoverPage(){const tocIcon=document.getElementsByClassName("icon-ic_toc_list");tocIcon[0].click();const tocParentDiv=tocIcon[0].parentElement.parentElement,tocList=tocParentDiv.querySelector("ul"),chapters=tocList.querySelectorAll("li");let chapterNames=[];return chapters.forEach(item=>{chapterNames.push(item.querySelector("span").innerText)}),tocList.children[0].click(),chapterNames}async function readBook(lastPage,chapterNames){let currentPage=1,highlightsObj={},cntr=1,nb1=[],nb2=[],t={},quitLoop=!1;for(;!isNaN(currentPage)&&currentPage<lastPage&&!1===quitLoop;){cntr++,t=scrapeCurrentPage(),currentPage=t.currentPage;const statusEl=document.getElementById("exifiling-status"),chapterHeading=document.getElementsByClassName("visually_hidden chapter_title_heading")[0].innerText;statusEl.innerHTML=`<p>Book: ${highlights.title}</p> <p>In <em>${chapterHeading}</em></p> <p> Loop ${cntr} <span id="polling"></span></p>`,highlightsObj=Object.assign(highlightsObj,t.scrapedHighlights),nb1=document.getElementsByClassName("only_next_btn"),nb2=document.getElementsByClassName("load_next_btn");const numChapters=chapterNames.length;nb1&&nb1.length>0?(nb1[0].scrollIntoView(),nb1[0].getElementsByTagName("button")[0].click(),await waitForChapterToLoad(chapterHeading)):nb2&&nb2.length>0&&chapterHeading!==chapterNames[numChapters-1]?(nb2[0].scrollIntoView(),nb2[0].click(),await waitForChapterToLoad(chapterHeading,currentPage)):(console.log("quitting loop"),quitLoop=!0)}return highlightsObj}async function waitForChapterToLoad(chapterHeading,currentPage){let currentChapterHeading=chapterHeading,currentPageAfterLoad=currentPage,awaitCntr=0;const pollEl=document.getElementById("polling");let pollDuration=300*awaitCntr;return new Promise(async(resolve,reject)=>{for(;currentChapterHeading===chapterHeading&&currentPage===currentPageAfterLoad&&300*awaitCntr<4e3;){awaitCntr++;let t=await timeout(300),m=4e3-300*awaitCntr;pollEl.innerHTML=`(${m}ms left)`,currentChapterHeading=document.getElementsByClassName("visually_hidden chapter_title_heading")[0].innerText,currentPageAfterLoad=Number(document.getElementById("footer").innerText.split(" ")[1])}resolve(!0)})}function scrapeCurrentPage(){scrollDownPage();const scrapedHighlights=scrapeHighlights(),currentPage=Number(document.getElementById("footer").innerText.split(" ")[1]),t={scrapedHighlights:scrapedHighlights,currentPage:currentPage};return t}function scrapeHighlights(){let pageHighlights={};const elems=document.getElementsByClassName("highlight");if(elems.length>0){for(let el of elems){const id=el.className.split(":")[1];pageHighlights[id]?pageHighlights[id].text.push(el.innerHTML):pageHighlights[id]={id:id,text:[el.innerHTML]}}return pageHighlights}return null}function showHighlightsWithButtons(e,highlights){overlay=document.createElement("main"),overlay.setAttribute("class","overlay-results"),e.innerHTML="Done Loading Highlights",document.body.removeChild(e),document.body.appendChild(overlay),addOverlayHeader({parentEl:overlay,highlights:highlights}),addFillButtonsHeader({parentEl:overlay,highlights:highlights}),addCloseButton(overlay),obj=createTextFile(highlights),displayText=obj.displayText,divText=document.createElement("div"),divText.setAttribute("class","highlights-text"),divText.innerHTML=displayText,overlay.appendChild(divText),addFooter(overlay)}const addOverlayHeader=({parentEl:parentEl})=>(overlayHeaderDiv=document.createElement("header"),overlayHeaderDiv.setAttribute("class","header-style"),overlay.appendChild(overlayHeaderDiv),overlayTitle=document.createElement("h2"),overlayTitle.innerHTML=highlights.title,overlayHeaderDiv.appendChild(overlayTitle),overlayAuthor=document.createElement("h4"),overlayAuthor.innerHTML=highlights.authors,overlayHeaderDiv.appendChild(overlayAuthor),overlayISBN=document.createElement("h4"),overlayISBN.innerHTML="ISBN: "+highlights.isbn,overlayHeaderDiv.appendChild(overlayISBN),null),addFillButtonsHeader=({parentEl:parentEl,highlights:highlights})=>(overlayButtons=document.createElement("div"),overlayButtons.setAttribute("class","buttons-header"),parentEl.appendChild(overlayButtons),nameStub="Exifile.Highlights_"+highlights.title.split(" ").join("."),obj=createTextFile(highlights),textFile=obj.textFile,jsonFile=JSON.stringify(highlights),addDownloadButton({parentEl:overlayButtons,stub:nameStub,file:jsonFile,type:"JSON"}),addDownloadButton({parentEl:overlayButtons,stub:nameStub,file:textFile,type:"Text"}),null),addDownloadButton=({parentEl:parentEl,stub:stub,file:file,type:type})=>(downloadButton=document.createElement("button"),downloadButton.setAttribute("class","download-button"),downloadButton.innerHTML=`Download ${type}`,downloadButton.onclick=()=>download(`${stub}.${type}`,file),parentEl.appendChild(downloadButton),null),addCloseButton=parentEl=>(closeButton=document.createElement("button"),closeButton.setAttribute("class","close-button"),closeButton.innerHTML="X",closeButton.onclick=()=>closeAll(parentEl),parentEl.appendChild(closeButton),null),addFooter=parentEl=>(footer=document.createElement("div"),footer.setAttribute("class","exifile-footer"),footer.innerHTML="<p><a href='https://oddumbrella.com/exifile/Exifile' target='_blank' rel='noopener noreferrer'>Exifile</a> by Suprada | Free your Scribd highlights</p>",parentEl.appendChild(footer),null);function createTextFile(highlights){const{title:title,authors:authors,isbn:isbn,annotations:annotations}=highlights;return textFile="",displayText="",displayText+='<ol class="all-quotes">',textFile+="TITLE: "+title+"\n",textFile+="AUTHORS: "+authors.join(", ")+"\n",textFile+="ISBN: "+isbn+"\n",annotations.forEach(item=>{textFile+="\n",displayText+='<li class="quote-style">',"highlight"===item.type?(displayText+='<span class="text">'+item.excerpt+"</span>",textFile+=item.excerpt+"\n"):"note"===item.type&&(textFile+="NOTE: "+item.excerpt+"\n",displayText+='<br><span class="note">Note: '+item.excerpt+"</span>"),textFile+="LOCATION: "+item.location+"\n",displayText+='<br><span class="page-number">'+item.location+"</span>",displayText+="</li>"}),displayText+="</ol>",{textFile:textFile,displayText:displayText}}function scrollDownPage(){const verticalPages=document.getElementsByClassName("vertical_page");var buttonsContainer;verticalPages[verticalPages.length-1].scrollIntoView(),document.getElementsByClassName("buttons_container")[0].scrollIntoView()}async function delayTimer(f,n){return await timeout(n),f()}function timeout(ms){return new Promise(resolve=>setTimeout(resolve,ms))}download=function download(filename,text){var element=document.createElement("a");element.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(text)),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)},closeAll=function(elem){document.body.removeChild(elem)}}();